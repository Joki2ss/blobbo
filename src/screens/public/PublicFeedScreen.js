import React, { useEffect, useMemo, useState } from "react";\nimport { View, Text, StyleSheet, ScrollView, Image, Pressable, useWindowDimensions } from "react-native";\nimport { Ionicons } from "@expo/vector-icons";\n\nimport { Screen } from "../../components/Screen";\nimport { Header } from "../../components/Header";\nimport { Card } from "../../components/Card";\nimport { TextField } from "../../components/TextField";\nimport { Button } from "../../components/Button";\nimport { useTheme } from "../../theme";\nimport { useAppActions, useAppState } from "../../store/AppStore";\nimport { getSupportRuntimeConfig } from "../../config/supportFlags";\nimport { isAdminOrBusiness } from "../../utils/roles";\nimport { isDeveloperUser } from "../../support/SupportPermissions";\nimport { ensureSeedPosts, searchFeedPosts } from "../../feed";\nimport { BUSINESSCAFE_DESCRIPTION_KEY, PRODUCT_NAME, selectBusinessCafePlaceholderImageKey } from "../../hub/BusinessCafeBranding";\nimport { t } from "../../i18n/strings";\n\nexport function PublicFeedScreen({ navigation }) {\n  const { session, backendMode, developerUnlocked } = useAppState();\n  const actions = useAppActions();\n  const theme = useTheme();\n  const styles = useMemo(() => makeStyles(theme), [theme]);\n  const dims = useWindowDimensions();\n\n  const user = session?.user || null;\n  const cfg = useMemo(() => getSupportRuntimeConfig({ backendMode }), [backendMode]);\n\n  const [query, setQuery] = useState("");\n  const [posts, setPosts] = useState([]);\n\n  const canCreate = useMemo(() => {\n    if (!user) return false;\n    if (isAdminOrBusiness(user.role)) return true;\n    return developerUnlocked && isDeveloperUser(user);\n  }, [user?.id, user?.role, developerUnlocked]);\n\n  const isDev = useMemo(() => developerUnlocked && isDeveloperUser(user), [developerUnlocked, user?.email]);\n\n  async function refresh() {\n    if (!cfg.PUBLIC_FEED_ENABLED) {\n      setPosts([]);\n      return;\n    }\n\n    if (backendMode === "MOCK") {\n      await ensureSeedPosts();\n    }\n\n    const list = await actions.safeCall(\n      () => searchFeedPosts({ query, includeAllForDeveloper: false }),\n      { title: "Feed" }\n    );\n\n    if (Array.isArray(list)) setPosts(list);\n  }\n\n  useEffect(() => {\n    refresh();\n  }, [backendMode, cfg.PUBLIC_FEED_ENABLED, query]);\n\n  const placeholderKey = useMemo(() => selectBusinessCafePlaceholderImageKey({ width: dims.width }), [dims.width]);\n\n  return (\n    <Screen>\n      <Header\n        title={PRODUCT_NAME}\n        subtitle={t(BUSINESSCAFE_DESCRIPTION_KEY)}\n        right={\n          user && canCreate ? (\n            <Pressable\n              onPress={() => navigation.navigate("PostEditor", { mode: "create" })}\n              style={({ pressed }) => [styles.iconWrap, pressed ? { opacity: 0.85 } : null]}\n            >\n              <Ionicons name="add" size={18} color={theme.colors.primary} />\n            </Pressable>\n          ) : null\n        }\n      />\n\n      <ScrollView contentContainerStyle={styles.content}>\n        {!cfg.PUBLIC_FEED_ENABLED ? (\n          <Card>\n            <Text style={styles.h}>Public feed disabled</Text>\n            <Text style={styles.muted}>This feature is disabled in this mode.</Text>\n          </Card>\n        ) : (\n          <>\n            <Card style={styles.card}>\n              <Text style={styles.muted}>Placeholder hero (not loaded): {placeholderKey}</Text>\n\n              <TextField\n                label="Search"\n                value={query}\n                onChangeText={setQuery}\n                placeholder="Search services, keywords, category..."\n                right={<Ionicons name="search" size={16} color={theme.colors.mutedText} />}\n              />\n\n              {!user ? (\n                <View style={{ marginTop: theme.spacing.sm }}>\n                  <Button title={t("cta.becomeBusiness")} onPress={() => navigation.navigate("BusinessSignup")} />\n                  <View style={{ height: theme.spacing.sm }} />\n                  <Button title={t("cta.login")} variant="secondary" onPress={() => navigation.navigate("Login")} />\n                </View>\n              ) : canCreate ? (\n                <Text style={styles.muted}>You can publish and manage posts from here.</Text>\n              ) : (\n                <Text style={styles.muted}>Browse and search. Business/admin accounts can publish posts.</Text>\n              )}\n\n              {isDev ? (\n                <View style={{ marginTop: theme.spacing.sm }}>\n                  <Button title="Developer feed control" variant="secondary" onPress={() => navigation.navigate("DeveloperFeed") } />\n                </View>\n              ) : null}\n            </Card>\n\n            {posts.length === 0 ? (\n              <View style={styles.empty}>\n                <Text style={styles.emptyText}>No posts found.</Text>\n              </View>\n            ) : (\n              posts.map((p) => (\n                <Card key={p.postId} style={styles.card}>\n                  <View style={styles.rowTop}>\n                    <View style={{ flex: 1 }}>\n                      <Text style={styles.title}>{p.title}</Text>\n                      <Text style={styles.meta}>{p.ownerBusinessName} • {p.ownerCategory}{p.location ? ` • ${p.location.city || p.location.region}` : ""}</Text>\n                    </View>\n                    {user && (isDev || p.ownerUserId === user.id) ? (\n                      <Pressable\n                        onPress={() => navigation.navigate("PostEditor", { mode: "edit", postId: p.postId })}\n                        style={({ pressed }) => [styles.iconWrap, pressed ? { opacity: 0.85 } : null]}\n                      >\n                        <Ionicons name="create-outline" size={18} color={theme.colors.primary} />\n                      </Pressable>\n                    ) : null}\n                  </View>\n\n                  {Array.isArray(p.images) && p.images.length > 0 ? (\n                    <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.imgRow}>\n                      {p.images.slice(0, 3).map((img, idx) => (\n                        <Image key={idx} source={{ uri: img.uri }} style={styles.img} />\n                      ))}\n                    </ScrollView>\n                  ) : null}\n\n                  <Text style={styles.desc} numberOfLines={6}>\n                    {stripHtml(p.description)}\n                  </Text>\n\n                  {Array.isArray(p.keywords) && p.keywords.length > 0 ? (\n                    <View style={styles.chips}>\n                      {p.keywords.slice(0, 8).map((k) => (\n                        <View key={k} style={styles.chip}>\n                          <Text style={styles.chipText}>#{k}</Text>\n                        </View>\n                      ))}\n                    </View>\n                  ) : null}\n                </Card>\n              ))\n            )}\n          </>\n        )}\n\n        {user ? null : (\n          <View style={{ height: theme.spacing.xl }} />\n        )}\n      </ScrollView>\n    </Screen>\n  );\n}\n\nfunction stripHtml(html) {\n  if (typeof html !== "string") return "";\n  return html.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();\n}\n\nfunction makeStyles(theme) {\n  return StyleSheet.create({\n    content: {\n      paddingBottom: theme.spacing.xl,\n    },\n    card: {\n      marginHorizontal: theme.spacing.lg,\n      marginBottom: theme.spacing.md,\n    },\n    headerRightRow: {\n      flexDirection: "row",\n      gap: theme.spacing.sm,\n    },\n    linkBtn: {\n      paddingHorizontal: theme.spacing.md,\n      paddingVertical: 10,\n      borderRadius: theme.radius.pill,\n      backgroundColor: theme.colors.chipBg,\n    },\n    linkText: {\n      ...theme.typography.h3,\n      color: theme.colors.text,\n    },\n    h: {\n      ...theme.typography.h3,\n      color: theme.colors.text,\n    },\n    muted: {\n      ...theme.typography.small,\n      color: theme.colors.mutedText,\n      marginTop: 6,\n    },\n    empty: {\n      padding: theme.spacing.xl,\n    },\n    emptyText: {\n      ...theme.typography.body,\n      color: theme.colors.mutedText,\n    },\n    rowTop: {\n      flexDirection: "row",\n      alignItems: "flex-start",\n      justifyContent: "space-between",\n      gap: theme.spacing.sm,\n    },\n    title: {\n      ...theme.typography.h3,\n      color: theme.colors.text,\n    },\n    meta: {\n      ...theme.typography.small,\n      color: theme.colors.mutedText,\n      marginTop: 4,\n    },\n    desc: {\n      ...theme.typography.body,\n      color: theme.colors.text,\n      marginTop: theme.spacing.sm,\n    },\n    imgRow: {\n      marginTop: theme.spacing.sm,\n      gap: theme.spacing.sm,\n    },\n    img: {\n      width: 120,\n      height: 90,\n      borderRadius: theme.radius.md,\n      backgroundColor: theme.colors.border,\n    },\n    chips: {\n      flexDirection: "row",\n      flexWrap: "wrap",\n      gap: theme.spacing.xs,\n      marginTop: theme.spacing.sm,\n    },\n    chip: {\n      backgroundColor: theme.colors.chipBg,\n      borderRadius: theme.radius.pill,\n      paddingHorizontal: theme.spacing.sm,\n      paddingVertical: 6,\n    },\n    chipText: {\n      ...theme.typography.small,\n      color: theme.colors.text,\n    },\n    iconWrap: {\n      width: 38,\n      height: 38,\n      borderRadius: theme.radius.md,\n      backgroundColor: theme.colors.chipBg,\n      alignItems: "center",\n      justifyContent: "center",\n    },\n  });\n}\n