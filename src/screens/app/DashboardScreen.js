import React, { useEffect, useMemo, useState } from "react";\nimport { View, StyleSheet, ScrollView, Text } from "react-native";\nimport { Ionicons } from "@expo/vector-icons";\n\nimport { Screen } from "../../components/Screen";\nimport { Header } from "../../components/Header";\nimport { KpiCard } from "../../components/KpiCard";\nimport { Card } from "../../components/Card";\nimport { Button } from "../../components/Button";\nimport { useTheme } from "../../theme";\nimport { useAppActions, useAppState } from "../../store/AppStore";\nimport { formatGreeting } from "../../utils/greeting";\nimport { t } from "../../i18n/strings";\n\nexport function DashboardScreen({ navigation }) {\n  const { session, workspace, backendMode } = useAppState();\n  const actions = useAppActions();\n  const theme = useTheme();\n  const styles = useMemo(() => makeStyles(theme), [theme]);\n\n  const [kpis, setKpis] = useState({ activeClients: 0, pendingDocs: 0, unreadMessages: 0 });\n\n  const subtitle = useMemo(() => {\n    if (!session?.user) return "";\n    const greeting = formatGreeting({ user: session.user });\n    return greeting || t("dashboard.subtitle");\n  }, [session, workspace, backendMode]);\n\n  const metaLine = useMemo(() => {\n    if (!session?.user || !workspace) return "";\n    return `${workspace.name} • ${session.user.role} • ${backendMode}`;\n  }, [session?.user?.id, workspace?.id, backendMode]);\n\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      if (!workspace) return;\n      const clients = await actions.safeCall(() => actions.backend.clients.list({ workspaceId: workspace.id }), { title: "Load failed" });\n      const threads = await actions.safeCall(() => actions.backend.chat.listThreads({ workspaceId: workspace.id }), { title: "Load failed" });\n\n      // pending docs: count requests with pending/partial\n      let pendingDocs = 0;\n      if (clients) {\n        for (const c of clients) {\n          const docs = await actions.backend.documents.listForClient({ workspaceId: workspace.id, clientId: c.id });\n          pendingDocs += docs.filter((d) => d.status !== "completed").length;\n        }\n      }\n\n      const unreadMessages = (threads || []).reduce((sum, t) => sum + (t.unreadCount || 0), 0);\n\n      if (mounted) {\n        setKpis({\n          activeClients: clients?.length || 0,\n          pendingDocs,\n          unreadMessages,\n        });\n      }\n    })();\n    return () => {\n      mounted = false;\n    };\n  }, [workspace?.id, backendMode]);\n\n  return (\n    <Screen>\n      <Header title="SXR Managements" subtitle={subtitle} />\n      <ScrollView contentContainerStyle={styles.content}>\n        {metaLine ? (\n          <Card style={styles.metaCard}>\n            <View style={styles.metaRow}>\n              <Text style={styles.metaText}>{metaLine}</Text>\n            </View>\n          </Card>\n        ) : null}\n        <View style={styles.kpiRow}>\n          <KpiCard\n            label="Active clients"\n            value={kpis.activeClients}\n            icon={<Ionicons name="people-outline" size={20} color={theme.colors.primary} />}\n          />\n          <View style={{ width: theme.spacing.md }} />\n          <KpiCard\n            label="Pending docs"\n            value={kpis.pendingDocs}\n            icon={<Ionicons name="document-text-outline" size={20} color={theme.colors.warning} />}\n          />\n        </View>\n\n        <View style={styles.kpiRow}>\n          <KpiCard\n            label="Unread messages"\n            value={kpis.unreadMessages}\n            icon={<Ionicons name="chatbubbles-outline" size={20} color={theme.colors.danger} />}\n          />\n          <View style={{ width: theme.spacing.md }} />\n          <Card style={styles.cardMini}>\n            <Button title="Ask support" onPress={() => navigation.navigate("Support")} />\n          </Card>\n        </View>\n\n        <Card>\n          <View style={styles.actionsCol}>\n            <Button title="Add client" onPress={() => navigation.navigate("NewClient")} />\n            <View style={{ height: theme.spacing.md }} />\n            <Button\n              title="New document request"\n              variant="secondary"\n              onPress={() => navigation.navigate("NewDocumentRequest")}\n            />\n            <View style={{ height: theme.spacing.md }} />\n            <Button title="Open support" variant="secondary" onPress={() => navigation.navigate("Support")} />\n          </View>\n        </Card>\n      </ScrollView>\n    </Screen>\n  );\n}\n\n\nfunction makeStyles(theme) {\n  return StyleSheet.create({\n    content: {\n      paddingHorizontal: theme.spacing.lg,\n      paddingBottom: theme.spacing.xl,\n    },\n    metaCard: {\n      marginBottom: theme.spacing.md,\n    },\n    metaRow: {\n      paddingVertical: theme.spacing.sm,\n    },\n    metaText: {\n      ...theme.typography.small,\n      color: theme.colors.mutedText,\n    },\n    kpiRow: {\n      flexDirection: "row",\n      marginBottom: theme.spacing.md,\n    },\n    cardMini: {\n      flex: 1,\n      padding: theme.spacing.lg,\n    },\n    actionsCol: {\n      paddingVertical: theme.spacing.sm,\n    },\n  });\n}\n